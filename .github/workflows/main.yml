name: Odoo OT & PO Reports

on:
  workflow_dispatch:
    inputs:
      script_choice:
        description: 'Select script to run'
        required: true
        default: 'All'
        type: choice
        options:
          - All
          - Ot_data_fetch.py
          - purchase_orders.py
      from_date:
        description: 'Start date (YYYY-MM-DD)'
        required: false
        default: '2025-07-26'
      to_date:
        description: 'End date (YYYY-MM-DD)'
        required: false
        default: ''
  schedule:
    - cron: '0 * * * *'  # Runs every hour at minute 0

jobs:
  run_reports:
    runs-on: ubuntu-latest
    env:
      ODOO_URL: ${{ secrets.ODOO_URL }}
      USERNAME: ${{ secrets.ODOO_USERNAME }}
      PASSWORD: ${{ secrets.ODOO_PASSWORD }}
      ODOO_DB: ${{ secrets.ODOO_DB }}
      GOOGLE_CREDS_B64: ${{ secrets.GOOGLE_CREDENTIALS_B64 }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install gspread oauth2client gspread_dataframe pytz requests

      - name: Decode Google Service Account
        run: |
          echo "$GOOGLE_CREDS_B64" | base64 --decode > gcreds.json

      - name: Determine script to run and dates
        id: script
        run: |
          # Set script choice
          if [ "${{ github.event.inputs.script_choice }}" = "" ]; then
            echo "SCRIPT=All" >> $GITHUB_ENV
          else
            echo "SCRIPT=${{ github.event.inputs.script_choice }}" >> $GITHUB_ENV
          fi

          # Set default FROM_DATE
          if [ -z "${{ github.event.inputs.from_date }}" ]; then
            FROM_DATE=$(date -d 'yesterday' +'%Y-%m-%d')
          else
            FROM_DATE=${{ github.event.inputs.from_date }}
          fi
          echo "FROM_DATE=$FROM_DATE" >> $GITHUB_ENV

          # Set default TO_DATE
          if [ -z "${{ github.event.inputs.to_date }}" ]; then
            TO_DATE=$(date -d 'yesterday' +'%Y-%m-%d')
          else
            TO_DATE=${{ github.event.inputs.to_date }}
          fi
          echo "TO_DATE=$TO_DATE" >> $GITHUB_ENV

          # Determine if we run all scripts
          if [ "${{ github.event.inputs.script_choice }}" = "All" ] || [ -z "${{ github.event.inputs.script_choice }}" ]; then
            echo "RUN_ALL=true" >> $GITHUB_ENV
          else
            echo "RUN_ALL=false" >> $GITHUB_ENV
          fi

      - name: Run OT Data Fetch
        if: env.SCRIPT == 'Ot_data_fetch.py' || env.RUN_ALL == 'true'
        run: |
          echo "Running OT Data Fetch from $FROM_DATE to $TO_DATE"
          python Ot_data_fetch.py --from_date $FROM_DATE --to_date $TO_DATE

      - name: Run Purchase Orders Fetch
        if: env.SCRIPT == 'purchase_orders.py' || env.RUN_ALL == 'true'
        run: |
          echo "Running Purchase Orders Fetch from $FROM_DATE to $TO_DATE"
          python purchase_orders.py --from_date $FROM_DATE --to_date $TO_DATE
